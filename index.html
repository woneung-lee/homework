<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ ì œì¶œí•´ì•¼ í•  ê²ƒ ì²´í¬ ë„êµ¬ & ë§ˆë²• ë‚˜ë¬´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --bg-red-soft: #ffecec;
      --bg-green-soft: #e6f6ec;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --red-main: #e74c3c;
      --green-main: #27ae60;
      --blue-main: #3498db;
      --orange-main: #e67e22;
      --text-main: #2c3e50;
      --text-sub: #7f8c8d;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }

    body {
      background: radial-gradient(circle at top, #ffe7e7 0, #fff7f0 45%, #ffecec 100%);
      min-height: 100vh;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px 0;
    }

    .container {
      max-width: 1400px;
      width: 100%;
      margin: 0 16px;
      padding: 20px 20px 24px;
      background: linear-gradient(135deg, #ffffff 0%, #fff5f5 40%, #f9fffb 100%);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .title-area {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--red-main);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title::before {
      content: "ğŸ„";
      font-size: 1.4rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    .control-area {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .date-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--border-soft);
      border-radius: 999px;
    }

    .date-selector input[type="date"] {
      border: none;
      font-size: 0.9rem;
      outline: none;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: #f0f0f0;
      color: var(--text-main);
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--red-main);
      color: white;
    }

    .tab-btn:hover:not(.active) {
      background: #e0e0e0;
    }

    .subject-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end; 
    }

    .subject-control input {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 0.9rem;
      min-width: 140px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-add {
      background: var(--green-main);
      color: #ffffff;
    }

    .btn-add:hover:not(:disabled) { opacity: 0.9; }

    .btn-blue {
      background: var(--blue-main);
      color: #ffffff;
    }

    .btn-blue:hover:not(:disabled) { opacity: 0.9; }

    .btn-orange {
      background: var(--orange-main);
      color: #ffffff;
    }

    .btn-orange:hover:not(:disabled) { opacity: 0.9; }

    /* 2ì—´ ë ˆì´ì•„ì›ƒ */
    .layout-2col {
      display: grid;
      grid-template-columns: 3fr 2fr; 
      gap: 16px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .layout-2col {
        grid-template-columns: 1fr;
      }
      .container {
        margin: 0 8px;
        padding: 16px;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
      padding: 12px 16px 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon { font-size: 1.1rem; }

    .card-description {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }
    
    /* ë§ˆë²• ë‚˜ë¬´ */
    .magic-tree-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%;
      min-height: 250px;
    }
    
    #treeVisual {
      font-size: 80px;
      transition: transform 0.5s ease-in-out, opacity 0.3s;
      line-height: 1;
      margin-bottom: 15px;
    }

    .magic-tree-area.celebrate #treeVisual {
        animation: pulse-and-spin 1.2s infinite alternate;
        color: var(--orange-main); 
        filter: drop-shadow(0 0 5px gold);
    }
    
    @keyframes pulse-and-spin {
        0% { transform: scale(1.3) rotate(-10deg); opacity: 1; text-shadow: 0 0 5px orange; }
        100% { transform: scale(1.5) rotate(10deg); opacity: 0.9; text-shadow: 0 0 15px var(--red-main); }
    }
    
    .tree-stage-info {
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .tree-message {
      font-size: 0.9rem;
      color: var(--text-sub);
    }
    
    .progress-bar-container { 
        width: 100%; 
        height: 20px; 
        background-color: #ddd; 
        border-radius: 10px; 
        margin-top: 10px; 
        overflow: hidden; 
    }

    #progressBar { 
        height: 100%; 
        width: 0%; 
        background-color: #4CAF50; 
        transition: width 1s ease-out; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        color: white; 
        font-weight: bold; 
        font-size: 10px;
    }

    .table-wrapper {
      overflow: auto;
      max-height: 65vh;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th, td {
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      text-align: center;
      background: #ffffff;
      word-wrap: break-word;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 5;
      background: #fff8f0;
      border-right: 2px solid #ffd7ba;
      width: 160px;
      min-width: 160px;
      max-width: 160px;
    }

    thead th:first-child {
      z-index: 11;
      background: linear-gradient(135deg, #ffdab3, #ffcca3);
      font-weight: 700;
      color: #8b4513;
    }

    thead th {
      background: linear-gradient(135deg, #ffefe6, #ffe3e3);
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .name-cell {
      font-weight: 500;
      font-size: 1rem;
      position: relative;
    }
    
    .student-actions {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
      gap: 2px;
    }

    .name-cell:hover .student-actions {
      display: flex;
    }

    .student-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.7rem;
      padding: 2px;
      opacity: 0.6;
    }

    .student-action-btn:hover { opacity: 1; }

    .subject-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .subject-header-name {
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .delete-subject-btn {
      border: none;
      background: transparent;
      color: #c0392b;
      cursor: pointer;
      font-size: 0.7rem;
      padding: 0 2px;
      line-height: 1;
      transition: all 0.2s;
      opacity: 0.7;
    }

    .delete-subject-btn:hover {
      transform: scale(1.15);
      opacity: 1;
    }

    .check-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 42px;
    }

    .hw-checkbox {
      width: 26px;
      height: 26px;
      cursor: pointer;
      accent-color: #e74c3c;
    }

    .summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
      overflow: auto;
      max-height: 70vh; 
      padding-right: 4px;
    }

    .summary-item {
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(135deg, #fef6f6, #f5fff9);
      border: 1px dashed #f0d1d1;
    }

    .summary-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .summary-subject {
      font-weight: 600;
      color: var(--red-main);
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .summary-count {
      font-size: 0.85rem;
      color: var(--green-main);
    }

    .summary-body {
      font-size: 0.85rem;
      color: var(--text-sub);
      line-height: 1.4;
    }

    .no-subjects {
      font-size: 0.85rem;
      color: var(--text-sub);
      font-style: italic;
    }
    
    /* ëª¨ë‹¬ */
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.5); 
      justify-content: center; 
      align-items: center; 
    }
    .modal.active { display: flex; }
    .modal-content { 
      background: white; 
      padding: 24px; 
      border-radius: 16px; 
      max-width: 500px; 
      width: 90%; 
      max-height: 80vh; 
      overflow-y: auto; 
    }
    .modal-header { 
      font-size: 1.2rem; 
      font-weight: 600; 
      margin-bottom: 16px; 
      color: var(--red-main); 
    }
    .modal-body { margin-bottom: 16px; }
    .modal-footer { 
      display: flex; 
      gap: 8px; 
      justify-content: flex-end; 
    }
    .form-group { margin-bottom: 12px; }
    .form-group label { 
      display: block; 
      margin-bottom: 4px; 
      font-size: 0.9rem; 
      color: var(--text-main); 
    }
    .form-group input { 
      width: 100%; 
      padding: 8px 12px; 
      border: 1px solid var(--border-soft); 
      border-radius: 8px; 
      font-size: 0.9rem; 
    }
    .student-list { 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
      max-height: 400px; 
      overflow-y: auto; 
    }
    .student-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 8px 12px; 
      background: #f9f9f9; 
      border-radius: 8px; 
    }
    .student-item-name { font-weight: 500; }
    .student-item-actions { display: flex; gap: 4px; }
    .chart-container { 
      position: relative; 
      height: 300px; 
      margin-top: 16px; 
    }
    .history-list { 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
    }
    .history-item { 
      padding: 12px; 
      background: #f9f9f9; 
      border-left: 4px solid var(--red-main); 
      border-radius: 8px; 
    }
    .history-date { 
      font-weight: 600; 
      color: var(--red-main); 
      margin-bottom: 8px; 
    }
    .history-subjects { 
      font-size: 0.85rem; 
      color: var(--text-sub); 
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title-area">
        <div class="title">ì˜¤ëŠ˜ì˜ ì œì¶œ(ë°œí‘œ)</div>
        <div class="subtitle">ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤ ğŸ’¾</div>
      </div>
      <div class="control-area">
        <div class="date-selector">
          <span>ğŸ“…</span>
          <input type="date" id="current-date" />
        </div>
        <button class="btn btn-blue" onclick="openStudentModal()">ğŸ‘¥ í•™ìƒ ê´€ë¦¬</button>
        <button class="btn btn-orange" onclick="exportToExcel()">ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-add" onclick="downloadBackup()">ğŸ’¾ ë°±ì—…</button>
      </div>
    </div>

    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab(event, 'check')">ğŸ“‹ ì˜¤ëŠ˜ ì²´í¬</button>
      <button class="tab-btn" onclick="switchTab(event, 'missing')">ğŸ”” ë¯¸ì œì¶œ í˜„í™©</button>
      <button class="tab-btn" onclick="switchTab(event, 'history')">ğŸ“… ë‚ ì§œë³„ ê¸°ë¡</button>
      <button class="tab-btn" onclick="switchTab(event, 'stats')">ğŸ“ˆ í†µê³„</button>
    </div>

    <div id="tab-check" class="tab-content active">
      <div class="subject-control" style="margin-bottom: 16px;">
        <input
          type="text"
          id="subject-input"
          placeholder="ê³¼ëª© ì´ë¦„ ì…ë ¥ (ì˜ˆ: ìˆ˜í•™ìµí˜ì±…)"
        />
        <button class="btn btn-add" id="add-subject-btn">
          â• ê³¼ëª© ì¶”ê°€
        </button>
      </div>

      <div class="layout-2col"> 
        <div class="card">
          <div class="card-title">
            <span class="icon">ğŸ“‹</span>
            <span>í•™ìƒë³„ ì œì¶œ ì—¬ë¶€ ì²´í¬í‘œ</span>
          </div>
          <div class="card-description">
            ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ë‚˜ë¬´ì— ë¬¼ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.
          </div>
          <div class="table-wrapper">
            <table id="homework-table">
              <thead id="table-head"></thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸŒ±</span>
                <span>ë§ˆë²• ë‚˜ë¬´ ì„±ì¥ í˜„í™©</span>
            </div>
            <div class="card-description">
                í•™ê¸‰ ì „ì²´ ì œì¶œë¥ ì´ ì˜¬ë¼ê°€ë©´ ë‚˜ë¬´ê°€ ì„±ì¥í•˜ê³  í™©ê¸ˆ ì—´ë§¤ë¥¼ ë§ºìŠµë‹ˆë‹¤!
            </div>
            <div class="magic-tree-area" id="tree-area-container">
                <div id="treeVisual">ğŸŒ°</div>
                <div class="progress-bar-container">
                    <div id="progressBar">0%</div>
                </div>
                <div class="tree-stage-info" id="treeStageInfo">í˜„ì¬ ë‹¨ê³„: ì”¨ì•—</div>
                <div class="tree-message" id="treeMessage">ì²« ì œì¶œë¡œ ë§ˆë²•ì˜ ì”¨ì•—ì„ ì‹¬ì–´ë´ìš”!</div>
            </div>
        </div>
      </div>
    </div>
    
    <div id="tab-missing" class="tab-content">
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ””</span>
                <span>ê³¼ëª©ë³„ ë¯¸ì œì¶œ í˜„í™©</span>
            </div>
            <div class="card-description">
                ê° ê³¼ëª©ë³„ë¡œ ì˜¤ëŠ˜ ì œì¶œí•˜ì§€ ì•Šì€ í•™ìƒ ì´ë¦„ì„ í‘œì‹œí•©ë‹ˆë‹¤.
            </div>
            <div id="summary-area" class="summary-list"></div>
        </div>
    </div>

    <div id="tab-history" class="tab-content">
      <div class="card">
        <div class="card-title">
          <span class="icon">ğŸ“…</span>
          <span>ë‚ ì§œë³„ ì œì¶œ ê¸°ë¡</span>
        </div>
        <div class="card-description">
          ê³¼ê±° ì œì¶œ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <div id="history-area" class="history-list"></div>
      </div>
    </div>

    <div id="tab-stats" class="tab-content">
      <div class="card">
        <div class="card-title">
          <span class="icon">ğŸ“ˆ</span>
          <span>í•™ìƒë³„Â·ê³¼ëª©ë³„ ì œì¶œë¥  í†µê³„</span>
        </div>
        <div class="card-description">
          í•™ìƒë³„Â·ê³¼ëª©ë³„ ì œì¶œë¥ ì„ ê·¸ë˜í”„ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <div class="chart-container">
          <canvas id="stats-chart"></canvas>
        </div>
        <div id="stats-detail" class="card-description" style="margin-top: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- í•™ìƒ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ‘¥ í•™ìƒ ê´€ë¦¬</div>
      <div class="modal-body">
        <div class="form-group">
          <label>í•™ìƒ ì´ë¦„</label>
          <input type="text" id="new-student-name" placeholder="í•™ìƒ ì´ë¦„ ì…ë ¥" />
        </div>
        <button class="btn btn-add" onclick="addStudent()" style="width: 100%; margin-bottom: 16px;">
          â• í•™ìƒ ì¶”ê°€
        </button>
        <div class="student-list" id="student-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeStudentModal()" style="background: #95a5a6; color: white;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ğŸŒ³ ë§ˆë²• ë‚˜ë¬´ ì„±ì¥ ë‹¨ê³„
    const stages = [
        { score: 0, name: "ì”¨ì•—", icon: "ğŸŒ°", message: "ì²« ì œì¶œ(ë°œí‘œ)ë¡œ ë§ˆë²•ì˜ ì”¨ì•—ì„ ì‹¬ì–´ë´ìš”!" },
        { score: 10, name: "ìƒˆì‹¹", icon: "ğŸŒ±", message: "íŠ¼íŠ¼í•œ ë‚˜ë¬´ê°€ ë  ê±°ì˜ˆìš”!" },
        { score: 30, name: "ì‘ì€ ë‚˜ë¬´", icon: "ğŸŒ³", message: "íŠ¼íŠ¼í•œ ë‚˜ë¬´ê°€ ë  ê±°ì˜ˆìš”!" }, 
        { score: 60, name: "í° ë‚˜ë¬´", icon: "ğŸŒ²", message: "í•™ê¸‰ì˜ ë…¸ë ¥ì´ ëª¨ì—¬ ë©‹ì§„ ë‚˜ë¬´ê°€ ë˜ì—ˆì–´ìš”." },
        { score: 90, name: "ê½ƒ", icon: "ğŸŒ¸", message: "ì¶•í•˜í•´ìš”! ì´ì œ ì—´ë§¤ë¥¼ ë§ºì„ ì¤€ë¹„ê°€ ë˜ì—ˆì–´ìš”!" },
        { score: 100, name: "í™©ê¸ˆ ì—´ë§¤", icon: "ğŸŠ", message: "ëª¨ë‘ 100% ë‹¬ì„±! í™©ê¸ˆ ì—´ë§¤ë¥¼ ìˆ˜í™•í–ˆì–´ìš”! ğŸ" } 
    ];

    let students = [];

    let subjects = [
      { id: "subj-1", name: "ìˆ˜í•™ìµí˜ì±…" }
    ];
    let subjectIdCounter = 2;
    const checkState = {
      "subj-1": new Array(students.length).fill(false)
    };
    let dailyRecords = {};

    const tableHead = document.getElementById("table-head");
    const tableBody = document.getElementById("table-body");
    const summaryArea = document.getElementById("summary-area");
    const subjectInput = document.getElementById("subject-input");
    const addSubjectBtn = document.getElementById("add-subject-btn");
    const currentDateInput = document.getElementById("current-date");
    const historyArea = document.getElementById("history-area");
    const statsDetail = document.getElementById("stats-detail");
    
    const treeVisual = document.getElementById('treeVisual');
    const progressBar = document.getElementById('progressBar');
    const treeStageInfo = document.getElementById('treeStageInfo');
    const treeMessage = document.getElementById('treeMessage');
    const treeAreaContainer = document.getElementById('tree-area-container');

    let currentDate = new Date().toISOString().split('T')[0];
    let statsChart = null;
    
    // --- ì´ˆê¸°í™” ---
    function init() {
      currentDateInput.value = currentDate;
      loadFromLocalStorage();
      loadDailyData();
      renderTable();
      renderStudentList();
      updateTreeVisuals(); 
    }

    function loadFromLocalStorage() {
      const savedStudents = localStorage.getItem('students');
      if (savedStudents) { students = JSON.parse(savedStudents); }
      const savedSubjects = localStorage.getItem('subjects');
      if (savedSubjects) {
        subjects = JSON.parse(savedSubjects);
        const maxId = Math.max(...subjects.map(s => parseInt(s.id.replace('subj-', ''))), 0);
        subjectIdCounter = maxId + 1;
      }
      const savedRecords = localStorage.getItem('dailyRecords');
      if (savedRecords) { dailyRecords = JSON.parse(savedRecords); }
    }

    function saveToLocalStorage() {
      localStorage.setItem('students', JSON.stringify(students));
      localStorage.setItem('subjects', JSON.stringify(subjects));
      localStorage.setItem('dailyRecords', JSON.stringify(dailyRecords));
    }

    function loadDailyData() {
      if (dailyRecords[currentDate]) {
        const data = dailyRecords[currentDate];
        subjects = data.subjects || subjects;
        Object.keys(data.checkState).forEach(key => {
          checkState[key] = data.checkState[key];
        });
      } else {
        subjects.forEach(subj => {
          checkState[subj.id] = new Array(students.length).fill(false);
        });
      }
    }

    function saveDailyData() {
      dailyRecords[currentDate] = {
        subjects: subjects,
        checkState: JSON.parse(JSON.stringify(checkState))
      };
      saveToLocalStorage();
    }

    currentDateInput.addEventListener('change', (e) => {
      saveDailyData(); 
      currentDate = e.target.value;
      loadDailyData(); 
      renderTable();
      updateTreeVisuals();
      switchTab(null, 'check');
    });

    function switchTab(evt, tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      if (evt && evt.target) {
        evt.target.classList.add('active');
      } else {
          document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`).classList.add('active');
      }
      document.getElementById(`tab-${tabName}`).classList.add('active');

      if (tabName === 'missing') {
          updateSummary();
      } else if (tabName === 'history') {
        renderHistory();
      } else if (tabName === 'stats') {
        renderStats();
      }
    }

    // --- ë§ˆë²• ë‚˜ë¬´ ---
    function calculateTotalRate() {
        let totalPossibleChecks = 0;
        let totalDoneChecks = 0;

        subjects.forEach(subj => {
            const stateArr = checkState[subj.id] || [];
            if (stateArr.length > 0) {
                totalPossibleChecks += students.length; 
                totalDoneChecks += stateArr.filter(c => c).length; 
            }
        });

        const rate = totalPossibleChecks > 0 ? (totalDoneChecks / totalPossibleChecks) * 100 : 0;
        return {
            rate: Math.round(rate),
            done: totalDoneChecks,
            total: totalPossibleChecks
        };
    }

    function updateTreeVisuals() {
        const { rate, done, total } = calculateTotalRate();
        
        progressBar.style.width = rate + '%';
        progressBar.textContent = `${rate}% (${done}/${total})`;
        
        let currentStageData = stages[0];
        for (let i = stages.length - 1; i >= 0; i--) {
            if (rate >= stages[i].score) {
                currentStageData = stages[i];
                break;
            }
        }
        
        treeVisual.textContent = currentStageData.icon;
        treeStageInfo.textContent = `í˜„ì¬ ë‹¨ê³„: ${currentStageData.name}`; 
        treeMessage.textContent = currentStageData.message;

        if (rate === 100) {
            treeAreaContainer.classList.add('celebrate');
            treeVisual.style.transform = ''; 
        } else {
            treeAreaContainer.classList.remove('celebrate');
            treeVisual.style.transform = 'scale(1)';
        }
    }

    function onCheckChange(el) {
      const subjId = el.dataset.subjectId;
      const idx = Number(el.dataset.studentIndex);

      if (!checkState[subjId]) {
        checkState[subjId] = new Array(students.length).fill(false);
      }
      checkState[subjId][idx] = el.checked;
      
      if (document.getElementById('tab-missing').classList.contains('active')) {
          updateSummary();
      }
      updateTreeVisuals(); 
      saveDailyData();
    }

    // --- ë Œë”ë§ ---
    function renderTable() {
      subjects.forEach((subj) => {
        if (!checkState[subj.id]) {
          checkState[subj.id] = new Array(students.length).fill(false);
        } else if (checkState[subj.id].length !== students.length) {
          const oldArr = checkState[subj.id];
          const newArr = new Array(students.length).fill(false);
          for (let i = 0; i < Math.min(oldArr.length, newArr.length); i++) {
            newArr[i] = oldArr[i];
          }
          checkState[subj.id] = newArr;
        }
      });
      
      let headHtml = "<tr>";
      headHtml += "<th class='name-cell'>ì´ë¦„</th>";
      subjects.forEach((subj) => {
        headHtml += `
          <th>
            <div class="subject-header">
              <span class="subject-header-name" title="${subj.name}">${subj.name}</span>
              <button class="delete-subject-btn" onclick="deleteSubject('${subj.id}')" title="ê³¼ëª© ì‚­ì œ">
                âŒ
              </button>
            </div>
          </th>
        `;
      });
      headHtml += "</tr>";
      tableHead.innerHTML = headHtml;

      let bodyHtml = "";
      students.forEach((studentName, idx) => {
        bodyHtml += "<tr>";
        bodyHtml += `
          <td class="name-cell">
            ${studentName}
            <div class="student-actions">
              <button class="student-action-btn" onclick="editStudent(${idx})" title="ìˆ˜ì •">âœï¸</button>
              <button class="student-action-btn" onclick="deleteStudent(${idx})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div>
          </td>
        `;

        subjects.forEach((subj) => {
          const checkboxId = `chk-${subj.id}-${idx}`;
          const isChecked = checkState[subj.id] && checkState[subj.id][idx] === true;
          bodyHtml += `
            <td>
              <div class="check-cell">
                <input
                  type="checkbox"
                  class="hw-checkbox"
                  id="${checkboxId}"
                  data-subject-id="${subj.id}"
                  data-student-index="${idx}"
                  ${isChecked ? "checked" : ""}
                  onchange="onCheckChange(this)"
                />
              </div>
            </td>
          `;
        });
        bodyHtml += "</tr>";
      });

      tableBody.innerHTML = bodyHtml;

      if (subjects.length === 0) {
        tableHead.innerHTML = `<tr><th class="name-cell">ì´ë¦„</th></tr>`;
        tableBody.innerHTML = students
          .map((name) => `<tr><td class="name-cell">${name}</td></tr>`)
          .join("");
      }
      updateTreeVisuals(); 
    }

    function updateSummary() {
      if (subjects.length === 0) {
        summaryArea.innerHTML = `<div class="no-subjects">í˜„ì¬ ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ê³¼ëª©ì„ ë¨¼ì € ì¶”ê°€í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>`;
        return;
      }

      let summaryHtml = "";

      subjects.forEach((subj) => {
        const stateArr = checkState[subj.id] || [];
        const total = students.length;
        let doneCount = 0;
        const notDoneNames = [];

        for (let i = 0; i < students.length; i++) {
          const checked = stateArr[i] === true;
          if (checked) {
            doneCount++;
          } else {
            notDoneNames.push(students[i]);
          }
        }

        const notDoneCount = total - doneCount;

        summaryHtml += `
          <div class="summary-item">
            <div class="summary-header">
              <div class="summary-subject">${subj.name}</div>
              <div class="summary-count">
                ì œì¶œ: ${doneCount}ëª… Â· ë¯¸ì œì¶œ: ${notDoneCount}ëª…
              </div>
            </div>
            <div class="summary-body">
              ${
                notDoneCount === 0
                  ? "ëª¨ë“  í•™ìƒì´ ì œì¶œí–ˆìŠµë‹ˆë‹¤. ğŸ"
                  : "ë¯¸ì œì¶œí•™ìƒ: " + notDoneNames.join(", ")
              }
            </div>
          </div>
        `;
      });

      summaryArea.innerHTML = summaryHtml;
    }

    // --- ì»¨íŠ¸ë¡¤ ---
    function addSubject() {
      const name = subjectInput.value.trim();
      if (!name) { alert("ì¶”ê°€í•  ê³¼ëª© ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
      const newId = "subj-" + subjectIdCounter++;
      subjects.push({ id: newId, name });
      checkState[newId] = new Array(students.length).fill(false);
      subjectInput.value = "";
      renderTable();
      saveDailyData();
      updateTreeVisuals(); 
    }

    function deleteSubject(id) {
      if (!confirm("í•´ë‹¹ ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í•´ë‹¹ ê³¼ëª©ì˜ ì²´í¬ ì •ë³´ë„ í•¨ê»˜ ì‚¬ë¼ì§‘ë‹ˆë‹¤.)")) { return; }
      subjects = subjects.filter((s) => s.id !== id);
      delete checkState[id];
      renderTable();
      saveDailyData();
      updateTreeVisuals(); 
    }

    function openStudentModal() {
      document.getElementById('student-modal').classList.add('active');
      renderStudentList();
    }

    function closeStudentModal() {
      document.getElementById('student-modal').classList.remove('active');
    }

    function renderStudentList() {
      const studentList = document.getElementById('student-list');
      let html = '';
      students.forEach((student, idx) => {
        html += `
          <div class="student-item">
            <span class="student-item-name">${student}</span>
            <div class="student-item-actions">
              <button class="btn" onclick="editStudent(${idx})" style="background: var(--blue-main); color: white; padding: 4px 8px; font-size: 0.8rem;">ìˆ˜ì •</button>
              <button class="btn" onclick="deleteStudent(${idx})" style="background: var(--red-main); color: white; padding: 4px 8px; font-size: 0.8rem;">ì‚­ì œ</button>
            </div>
          </div>
        `;
      });
      studentList.innerHTML = html || '<p style="text-align: center; color: #999;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function addStudent() {
      const name = document.getElementById('new-student-name').value.trim();
      if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      if (students.includes(name)) { alert('ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì…ë‹ˆë‹¤.'); return; }
      students.push(name);
      subjects.forEach(subj => { if (checkState[subj.id]) { checkState[subj.id].push(false); } });
      document.getElementById('new-student-name').value = '';
      renderStudentList();
      renderTable();
      saveToLocalStorage();
      saveDailyData();
      updateTreeVisuals();
    }

    function editStudent(idx) {
      const newName = prompt('ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', students[idx]);
      if (newName && newName.trim()) {
        students[idx] = newName.trim();
        renderStudentList();
        renderTable();
        saveToLocalStorage();
        saveDailyData();
      }
    }

    function deleteStudent(idx) {
      if (!confirm(`${students[idx]} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ëª¨ë“  ì œì¶œ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.)`)) { return; }
      students.splice(idx, 1);
      subjects.forEach(subj => { if (checkState[subj.id]) { checkState[subj.id].splice(idx, 1); } });
      renderStudentList();
      renderTable();
      saveToLocalStorage();
      saveDailyData();
      updateTreeVisuals();
    }

    // --- Excel ë‚´ë³´ë‚´ê¸° ---
    function exportToExcel() {
      try {
        const wb = XLSX.utils.book_new();

        // 1. ì˜¤ëŠ˜ ì œì¶œ í˜„í™©
        const todayData = [];
        todayData.push(['ë‚ ì§œ', currentDate]);
        todayData.push([]);
        
        const headerRow = ['í•™ìƒ ì´ë¦„', ...subjects.map(s => s.name)];
        todayData.push(headerRow);

        students.forEach((student, idx) => {
          const row = [student];
          subjects.forEach(subj => {
            const isChecked = checkState[subj.id] && checkState[subj.id][idx];
            row.push(isChecked ? 'O' : 'X');
          });
          todayData.push(row);
        });

        const ws1 = XLSX.utils.aoa_to_sheet(todayData);
        XLSX.utils.book_append_sheet(wb, ws1, 'ì˜¤ëŠ˜ ì œì¶œí˜„í™©');

        // 2. ì „ì²´ ê¸°ë¡
        const allRecordsData = [];
        allRecordsData.push(['ë‚ ì§œë³„ ì „ì²´ ì œì¶œ ê¸°ë¡']);
        allRecordsData.push([]);

        const dates = Object.keys(dailyRecords).sort();
        dates.forEach(date => {
          allRecordsData.push([`[${date}]`]);
          const record = dailyRecords[date];
          const recordSubjects = record.subjects || [];
          
          if (recordSubjects.length > 0) {
            const headerRow = ['í•™ìƒ', ...recordSubjects.map(s => s.name)];
            allRecordsData.push(headerRow);

            students.forEach((student, idx) => {
              const row = [student];
              recordSubjects.forEach(subj => {
                const isChecked = record.checkState[subj.id] && record.checkState[subj.id][idx];
                row.push(isChecked ? 'O' : 'X');
              });
              allRecordsData.push(row);
            });
          }
          allRecordsData.push([]);
        });

        const ws2 = XLSX.utils.aoa_to_sheet(allRecordsData);
        XLSX.utils.book_append_sheet(wb, ws2, 'ì „ì²´ ê¸°ë¡');

        // 3. í†µê³„
        const statsData = [];
        statsData.push(['í•™ìƒë³„ ì œì¶œë¥  í†µê³„']);
        statsData.push(['í•™ìƒ ì´ë¦„', 'ì œì¶œ íšŸìˆ˜', 'ì „ì²´ íšŸìˆ˜', 'ì œì¶œë¥ (%)']);

        const studentStats = {};
        students.forEach(student => {
          studentStats[student] = { done: 0, total: 0 };
        });

        Object.values(dailyRecords).forEach(record => {
          const recordSubjects = record.subjects || [];
          recordSubjects.forEach(subj => {
            const stateArr = record.checkState[subj.id] || [];
            students.forEach((student, idx) => {
              studentStats[student].total++;
              if (stateArr[idx]) {
                studentStats[student].done++;
              }
            });
          });
        });

        students.forEach(student => {
          const stats = studentStats[student];
          const rate = stats.total > 0 ? ((stats.done / stats.total) * 100).toFixed(1) : 0;
          statsData.push([student, stats.done, stats.total, rate]);
        });

        const ws3 = XLSX.utils.aoa_to_sheet(statsData);
        XLSX.utils.book_append_sheet(wb, ws3, 'í†µê³„');

        XLSX.writeFile(wb, `ì œì¶œí˜„í™©_${currentDate}.xlsx`);
        alert('Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“Š');
      } catch (error) {
        console.error('Excel ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
        alert('Excel ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // --- JSON ë°±ì—… ---
    function downloadBackup() {
      const backupData = {
        students,
        subjects,
        dailyRecords,
        subjectIdCounter,
        exportDate: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ì œì¶œì²´í¬_ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾\nì•ˆì „í•œ ê³³ì— ë³´ê´€í•´ì£¼ì„¸ìš”.');
    }

    // --- ë‚ ì§œë³„ ê¸°ë¡ ---
    function renderHistory() {
      const dates = Object.keys(dailyRecords).sort().reverse();
      
      if (dates.length === 0) {
        historyArea.innerHTML = '<p style="text-align: center; color: #999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      let html = '';
      dates.forEach(date => {
        const record = dailyRecords[date];
        const recordSubjects = record.subjects || [];
        
        let subjectsText = recordSubjects.map(s => s.name).join(', ');
        if (subjectsText.length === 0) subjectsText = 'ê³¼ëª© ì—†ìŒ';

        let totalChecks = 0;
        let doneChecks = 0;
        recordSubjects.forEach(subj => {
          const stateArr = record.checkState[subj.id] || [];
          totalChecks += students.length;
          doneChecks += stateArr.filter(c => c).length;
        });
        const rate = totalChecks > 0 ? Math.round((doneChecks / totalChecks) * 100) : 0;

        html += `
          <div class="history-item">
            <div class="history-date">ğŸ“… ${date} (ì œì¶œë¥ : ${rate}%)</div>
            <div class="history-subjects">ê³¼ëª©: ${subjectsText}</div>
          </div>
        `;
      });

      historyArea.innerHTML = html;
    }

    // --- í†µê³„ ---
    function renderStats() {
      const studentStats = {};
      students.forEach(student => {
        studentStats[student] = { done: 0, total: 0 };
      });

      Object.values(dailyRecords).forEach(record => {
        const recordSubjects = record.subjects || [];
        recordSubjects.forEach(subj => {
          const stateArr = record.checkState[subj.id] || [];
          students.forEach((student, idx) => {
            studentStats[student].total++;
            if (stateArr[idx]) {
              studentStats[student].done++;
            }
          });
        });
      });

      const labels = students;
      const rates = students.map(student => {
        const stats = studentStats[student];
        return stats.total > 0 ? ((stats.done / stats.total) * 100).toFixed(1) : 0;
      });

      if (statsChart) {
        statsChart.destroy();
      }

      const ctx = document.getElementById('stats-chart').getContext('2d');
      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ì œì¶œë¥  (%)',
            data: rates,
            backgroundColor: 'rgba(231, 76, 60, 0.6)',
            borderColor: 'rgba(231, 76, 60, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: true
            }
          }
        }
      });

      let detailHtml = '<strong>í•™ìƒë³„ ìƒì„¸ í†µê³„:</strong><br>';
      students.forEach(student => {
        const stats = studentStats[student];
        const rate = stats.total > 0 ? ((stats.done / stats.total) * 100).toFixed(1) : 0;
        detailHtml += `${student}: ${stats.done}/${stats.total} (${rate}%) `;
      });
      statsDetail.innerHTML = detailHtml;
    }
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    addSubjectBtn.addEventListener("click", addSubject);
    subjectInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { addSubject(); }
    });
    document.getElementById('student-modal').addEventListener('click', (e) => {
      if (e.target.id === 'student-modal') { closeStudentModal(); }
    });

    // ì´ˆê¸°í™”
    init();

    // ì „ì—­ í•¨ìˆ˜
    window.deleteSubject = deleteSubject;
    window.onCheckChange = onCheckChange;
    window.updateSummary = updateSummary;
    window.openStudentModal = openStudentModal;
    window.closeStudentModal = closeStudentModal;
    window.addStudent = addStudent;
    window.editStudent = editStudent;
    window.deleteStudent = deleteStudent;
    window.exportToExcel = exportToExcel;
    window.downloadBackup = downloadBackup;
    window.renderHistory = renderHistory;
    window.renderStats = renderStats;
  </script>
</body>
</html>
